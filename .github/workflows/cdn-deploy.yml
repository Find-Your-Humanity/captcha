name: CDN Deploy

on:
    push:
        branches:
            - main
            - develop  
            - dev-cdn
        tags:
            - 'v*'

jobs:
    build-and-deploy-cdn:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install dependencies
              run: npm install --legacy-peer-deps

            - name: Build for CDN
              run: npm run build:cdn

            - name: Deploy to CDN (dev-cdn 브랜치)
              if: github.ref == 'refs/heads/dev-cdn'
              env:
                  KAKAO_ACCESS_KEY: ${{ secrets.KAKAO_ACCESS_KEY }}
                  KAKAO_SECRET_KEY: ${{ secrets.KAKAO_SECRET_KEY }}
                  KAKAO_REGION: kr-central-1
                  KAKAO_CDN_BUCKET: realcaptcha-cdn
                  KAKAO_CDN_DOMAIN: 1df60f5faf3b4f2f992ced2edbae22ad.kakaoiedge.com
                  REACT_APP_VERSION: dev
              run: npm run deploy:kakao

            - name: Deploy to CDN (develop 브랜치 - 스테이징)
              if: github.ref == 'refs/heads/develop'
              env:
                  KAKAO_ACCESS_KEY: ${{ secrets.KAKAO_ACCESS_KEY }}
                  KAKAO_SECRET_KEY: ${{ secrets.KAKAO_SECRET_KEY }}
                  KAKAO_REGION: kr-central-1
                  KAKAO_CDN_BUCKET: realcaptcha-cdn-staging
                  KAKAO_CDN_DOMAIN: ${{ vars.STAGING_KAKAO_DOMAIN }}
                  REACT_APP_VERSION: staging
              run: npm run deploy:kakao

            - name: Deploy to CDN (main/태그 - 프로덕션)  
              if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
              env:
                  KAKAO_ACCESS_KEY: ${{ secrets.KAKAO_ACCESS_KEY }}
                  KAKAO_SECRET_KEY: ${{ secrets.KAKAO_SECRET_KEY }}
                  KAKAO_REGION: kr-central-1
                  KAKAO_CDN_BUCKET: realcaptcha-cdn
                  KAKAO_CDN_DOMAIN: 1df60f5faf3b4f2f992ced2edbae22ad.kakaoiedge.com
                  REACT_APP_VERSION: ${{ github.ref_name }}
              run: npm run deploy:kakao